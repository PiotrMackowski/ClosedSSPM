<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>{{ .Title }}</title>
<style>
  :root {
    --bg: #0d1117; --surface: #161b22; --border: #30363d;
    --text: #e6edf3; --text-muted: #8b949e;
    --critical: #f85149; --high: #db6d28; --medium: #d29922;
    --low: #3fb950; --info: #58a6ff;
    --score-a: #3fb950; --score-b: #56d364; --score-c: #d29922;
    --score-d: #db6d28; --score-f: #f85149;
  }
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, Arial, sans-serif;
    background: var(--bg); color: var(--text); line-height: 1.6; padding: 2rem; }
  .container { max-width: 1200px; margin: 0 auto; }
  h1 { font-size: 1.8rem; margin-bottom: 0.5rem; }
  h2 { font-size: 1.4rem; margin: 2rem 0 1rem; border-bottom: 1px solid var(--border); padding-bottom: 0.5rem; }
  h3 { font-size: 1.1rem; margin: 1rem 0 0.5rem; }
  .meta { color: var(--text-muted); font-size: 0.85rem; margin-bottom: 2rem; }

  /* Summary cards */
  .summary-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 1rem; margin-bottom: 2rem; }
  .card { background: var(--surface); border: 1px solid var(--border); border-radius: 6px; padding: 1.2rem; }
  .card-value { font-size: 2rem; font-weight: 700; }
  .card-label { color: var(--text-muted); font-size: 0.85rem; text-transform: uppercase; letter-spacing: 0.05em; }

  /* Severity badges */
  .badge { display: inline-block; padding: 2px 8px; border-radius: 12px; font-size: 0.75rem;
    font-weight: 600; text-transform: uppercase; }
  .badge.critical { background: var(--critical); color: #fff; }
  .badge.high { background: var(--high); color: #fff; }
  .badge.medium { background: var(--medium); color: #000; }
  .badge.low { background: var(--low); color: #000; }
  .badge.info { background: var(--info); color: #000; }

  /* Score */
  .score { font-size: 3rem; font-weight: 800; }
  .score-a { color: var(--score-a); }
  .score-b { color: var(--score-b); }
  .score-c { color: var(--score-c); }
  .score-d { color: var(--score-d); }
  .score-f { color: var(--score-f); }

  /* Findings */
  .finding { background: var(--surface); border: 1px solid var(--border); border-radius: 6px;
    padding: 1rem 1.2rem; margin-bottom: 0.75rem; }
  .finding-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem; }
  .finding-title { font-weight: 600; }
  .finding-id { color: var(--text-muted); font-size: 0.8rem; font-family: monospace; }
  .finding-body { font-size: 0.9rem; color: var(--text-muted); }
  .finding-body p { margin: 0.3rem 0; }
  .finding-resource { font-family: monospace; font-size: 0.8rem; color: var(--info); }
  .finding-remediation { margin-top: 0.5rem; padding: 0.5rem; background: rgba(56,139,253,0.1);
    border-radius: 4px; font-size: 0.85rem; }

  /* Evidence table */
  .evidence-table { width: 100%; border-collapse: collapse; margin-top: 0.5rem; font-size: 0.8rem; }
  .evidence-table th, .evidence-table td { padding: 4px 8px; text-align: left;
    border-bottom: 1px solid var(--border); }
  .evidence-table th { color: var(--text-muted); font-weight: 600; }

  /* Collection stats */
  .stats-table { width: 100%; border-collapse: collapse; }
  .stats-table th, .stats-table td { padding: 6px 12px; text-align: left;
    border-bottom: 1px solid var(--border); }
  .stats-table th { color: var(--text-muted); font-weight: 600; }
  .stats-table td:last-child { text-align: right; font-family: monospace; }

  /* Controls Toolbar */
  .toolbar { background: var(--surface); border: 1px solid var(--border); border-radius: 8px;
    padding: 1rem; margin: 2rem 0; display: flex; flex-wrap: wrap; gap: 1.5rem;
    align-items: center; box-shadow: 0 4px 20px rgba(0,0,0,0.2); position: sticky; top: 0; z-index: 100; }
  .toolbar-group { display: flex; align-items: center; gap: 0.75rem; flex-wrap: wrap; }
  .toolbar-label { font-size: 0.85rem; color: var(--text-muted); text-transform: uppercase;
    letter-spacing: 0.05em; font-weight: 600; }
  .filter-btn { background: transparent; border: 1px solid var(--border); color: var(--text);
    padding: 0.4rem 0.8rem; border-radius: 20px; font-size: 0.75rem; font-weight: 600;
    cursor: pointer; transition: all 0.2s ease; }
  .filter-btn:hover { background: rgba(255,255,255,0.05); }
  .filter-btn.active { background: var(--btn-color, var(--text)); color: var(--btn-text, var(--bg));
    border-color: var(--btn-color, var(--text)); box-shadow: 0 0 10px var(--btn-color, rgba(255,255,255,0.2)); }
  .group-select { background: var(--bg); color: var(--text); border: 1px solid var(--border);
    padding: 0.4rem 0.8rem; border-radius: 6px; font-size: 0.85rem; outline: none; cursor: pointer; }
  .group-select:focus { border-color: var(--info); }
  .search-input { background: var(--bg); color: var(--text); border: 1px solid var(--border);
    padding: 0.4rem 0.8rem; border-radius: 6px; font-size: 0.85rem; outline: none;
    width: 220px; transition: border-color 0.2s ease; }
  .search-input:focus { border-color: var(--info); }
  .search-input::placeholder { color: var(--text-muted); }
  .count-display { margin-left: auto; font-size: 0.9rem; color: var(--text-muted); }
  .count-display strong { color: var(--text); }

  /* Collapsible group headers */
  .group-section { margin-bottom: 0.5rem; }
  .group-header { display: flex; align-items: center; justify-content: space-between;
    cursor: pointer; user-select: none; padding: 0.6rem 0; transition: color 0.15s ease; }
  .group-header:hover { color: var(--info); }
  .group-header .chevron { display: inline-block; width: 1rem; font-size: 0.85rem;
    transition: transform 0.2s ease; margin-right: 0.5rem; flex-shrink: 0; color: var(--text-muted); }
  .group-header .chevron.open { transform: rotate(90deg); }
  .group-header-left { display: flex; align-items: center; }
  .group-count { font-size: 0.9rem; color: var(--text-muted); font-weight: normal; margin-left: 0.5rem; }
  .group-findings { overflow: hidden; }
  .group-severity-summary { display: flex; gap: 0.4rem; }
  .group-severity-summary .badge { font-size: 0.65rem; padding: 1px 6px; }

  /* Expand/Collapse all */
  .expand-collapse-btn { background: transparent; border: 1px solid var(--border); color: var(--text-muted);
    padding: 0.3rem 0.6rem; border-radius: 4px; font-size: 0.75rem; cursor: pointer;
    transition: all 0.2s ease; }
  .expand-collapse-btn:hover { background: rgba(255,255,255,0.05); color: var(--text); }

  /* No results message */
  .no-results { text-align: center; padding: 3rem 1rem; color: var(--text-muted); font-size: 1.1rem; }

  /* Responsive */
  @media (max-width: 768px) {
    body { padding: 1rem; }
    .summary-grid { grid-template-columns: 1fr 1fr; }
    .search-input { width: 100%; }
    .toolbar { position: static; }
  }
</style>
</head>
<body>
<div class="container">

<h1>{{ .Title }}</h1>
<div class="meta">
  Generated: {{ .GeneratedAt }}
  {{ if .InstanceURL }}| Instance: {{ .InstanceURL }}{{ end }}
  {{ if .Platform }}| Platform: {{ .Platform }}{{ end }}
</div>

<!-- Executive Summary -->
<h2>Executive Summary</h2>
<div class="summary-grid">
  <div class="card">
    <div class="card-value score {{ scoreClass .Summary.PostureScore }}">{{ .Summary.PostureScore }}</div>
    <div class="card-label">Posture Score</div>
  </div>
  <div class="card">
    <div class="card-value">{{ .Summary.Total }}</div>
    <div class="card-label">Total Findings</div>
  </div>
  {{ range .SeverityList }}
  {{ $count := index $.Summary.BySeverity . }}
  {{ if $count }}
  <div class="card">
    <div class="card-value" style="color: var(--{{ severityClass . }})">{{ $count }}</div>
    <div class="card-label">{{ . }}</div>
  </div>
  {{ end }}
  {{ end }}
</div>

<!-- Controls Toolbar -->
<div class="toolbar">
  <div class="toolbar-group">
    <span class="toolbar-label">Severity:</span>
    <button class="filter-btn active" data-filter="ALL">ALL</button>
    <button class="filter-btn" data-filter="CRITICAL" style="--btn-color: var(--critical); --btn-text: #fff">CRITICAL</button>
    <button class="filter-btn" data-filter="HIGH" style="--btn-color: var(--high); --btn-text: #fff">HIGH</button>
    <button class="filter-btn" data-filter="MEDIUM" style="--btn-color: var(--medium); --btn-text: #000">MEDIUM</button>
    <button class="filter-btn" data-filter="LOW" style="--btn-color: var(--low); --btn-text: #000">LOW</button>
    <button class="filter-btn" data-filter="INFO" style="--btn-color: var(--info); --btn-text: #000">INFO</button>
  </div>
  <div class="toolbar-group">
    <span class="toolbar-label">Search:</span>
    <input type="text" id="search-input" class="search-input" placeholder="Filter findings..." autocomplete="off" spellcheck="false">
  </div>
  <div class="toolbar-group">
    <span class="toolbar-label">Group by:</span>
    <select id="group-by-select" class="group-select">
      <option value="category" selected>Category</option>
      <option value="policyId">Policy ID</option>
      <option value="severity">Severity</option>
    </select>
  </div>
  <div class="toolbar-group">
    <button class="expand-collapse-btn" id="expand-all-btn">Expand All</button>
    <button class="expand-collapse-btn" id="collapse-all-btn">Collapse All</button>
  </div>
  <div class="count-display">
    Showing <strong id="visible-count">{{ .Summary.Total }}</strong> of <strong id="total-count">{{ .Summary.Total }}</strong> findings
  </div>
</div>

<!-- Findings container — populated by JS from embedded JSON data -->
<div id="findings-container"></div>

<!-- Collection Statistics -->
{{ if .TableStats }}
<h2>Collection Statistics</h2>
<table class="stats-table">
  <tr><th>Table</th><th>Records</th></tr>
  {{ range .TableStats }}
  <tr><td>{{ .Name }}</td><td>{{ .Count }}</td></tr>
  {{ end }}
</table>
{{ end }}

</div>

<!-- Findings data embedded as JSON — parsed by JS, never rendered as DOM by the browser -->
<script id="report-data" type="application/json">{{ .FindingsJSON }}</script>

<script>
(function() {
  "use strict";

  // --- Parse embedded JSON data ---
  var dataEl = document.getElementById("report-data");
  if (!dataEl) return;
  var findings;
  try {
    findings = JSON.parse(dataEl.textContent);
  } catch (e) {
    console.error("Failed to parse report data:", e);
    return;
  }

  // Pre-compute searchable text and normalized fields for each finding.
  var items = findings.map(function(f) {
    return {
      raw: f,
      severity: (f.severity || "").toUpperCase(),
      category: f.category || "",
      policyId: f.policy_id || "",
      title: f.title || "",
      searchText: [
        f.title, f.policy_id, f.category, f.severity, f.resource, f.description
      ].filter(Boolean).join(" ").toLowerCase()
    };
  });

  var container = document.getElementById("findings-container");
  var totalCountEl = document.getElementById("total-count");
  var visibleCountEl = document.getElementById("visible-count");
  var searchInput = document.getElementById("search-input");
  var filterBtns = document.querySelectorAll(".filter-btn");
  var groupBySelect = document.getElementById("group-by-select");
  var expandAllBtn = document.getElementById("expand-all-btn");
  var collapseAllBtn = document.getElementById("collapse-all-btn");

  if (totalCountEl) totalCountEl.textContent = items.length;
  if (visibleCountEl) visibleCountEl.textContent = items.length;

  var activeFilters = { ALL: true };
  var currentGroup = "category";
  var searchTerm = "";
  var debounceTimer = null;
  var expandedGroups = {};

  // --- Render a single finding card from JSON data ---
  function renderFinding(f) {
    var raw = f.raw;
    var el = document.createElement("div");
    el.className = "finding";

    var headerDiv = document.createElement("div");
    headerDiv.className = "finding-header";

    var leftDiv = document.createElement("div");
    var titleSpan = document.createElement("span");
    titleSpan.className = "finding-title";
    titleSpan.textContent = raw.title || "";
    var idSpan = document.createElement("span");
    idSpan.className = "finding-id";
    idSpan.textContent = raw.policy_id || "";
    leftDiv.appendChild(titleSpan);
    leftDiv.appendChild(document.createTextNode(" "));
    leftDiv.appendChild(idSpan);

    var badge = document.createElement("span");
    badge.className = "badge " + f.severity.toLowerCase();
    badge.textContent = f.severity;

    headerDiv.appendChild(leftDiv);
    headerDiv.appendChild(badge);
    el.appendChild(headerDiv);

    var body = document.createElement("div");
    body.className = "finding-body";

    if (raw.description) {
      var p = document.createElement("p");
      p.textContent = raw.description;
      body.appendChild(p);
    }

    if (raw.resource) {
      var res = document.createElement("div");
      res.className = "finding-resource";
      res.textContent = raw.resource;
      body.appendChild(res);
    }

    if (raw.evidence && raw.evidence.length > 0) {
      var table = document.createElement("table");
      table.className = "evidence-table";
      var thead = document.createElement("tr");
      var th1 = document.createElement("th");
      th1.textContent = "Field";
      var th2 = document.createElement("th");
      th2.textContent = "Value";
      thead.appendChild(th1);
      thead.appendChild(th2);
      table.appendChild(thead);

      raw.evidence.forEach(function(ev) {
        if (ev.fields) {
          Object.keys(ev.fields).forEach(function(k) {
            var tr = document.createElement("tr");
            var td1 = document.createElement("td");
            td1.textContent = k;
            var td2 = document.createElement("td");
            td2.textContent = ev.fields[k];
            tr.appendChild(td1);
            tr.appendChild(td2);
            table.appendChild(tr);
          });
        }
      });
      body.appendChild(table);
    }

    if (raw.remediation) {
      var rem = document.createElement("div");
      rem.className = "finding-remediation";
      rem.innerHTML = "<strong>Remediation:</strong> " + escapeHTML(raw.remediation);
      body.appendChild(rem);
    }

    el.appendChild(body);
    return el;
  }

  // --- Build severity summary badges HTML for a group ---
  function buildSeveritySummaryHTML(groupItems) {
    var counts = {};
    groupItems.forEach(function(d) {
      counts[d.severity] = (counts[d.severity] || 0) + 1;
    });
    var order = ["CRITICAL", "HIGH", "MEDIUM", "LOW", "INFO"];
    return order.filter(function(s) { return counts[s]; })
      .map(function(s) { return '<span class="badge ' + s.toLowerCase() + '">' + counts[s] + " " + s + "</span>"; })
      .join("");
  }

  // --- Toggle group expand/collapse with lazy DOM rendering ---
  function toggleGroup(section, groupItems) {
    var body = section.querySelector(".group-findings");
    var chevron = section.querySelector(".chevron");
    var key = section.getAttribute("data-group-key");
    if (!body) return;

    if (body.style.display === "none" || !body.hasChildNodes()) {
      // Expand: render finding DOM lazily.
      if (!body.hasChildNodes()) {
        var frag = document.createDocumentFragment();
        groupItems.forEach(function(d) {
          frag.appendChild(renderFinding(d));
        });
        body.appendChild(frag);
      }
      body.style.display = "";
      if (chevron) chevron.classList.add("open");
      if (key) expandedGroups[key] = true;
    } else {
      // Collapse: hide but keep DOM (already rendered).
      body.style.display = "none";
      if (chevron) chevron.classList.remove("open");
      if (key) delete expandedGroups[key];
    }
  }

  // --- Render all group headers (no finding DOM yet — that's lazy) ---
  function renderGroups(visibleItems) {
    if (visibleCountEl) visibleCountEl.textContent = visibleItems.length;

    // Group items.
    var groups = {};
    var groupOrder = [];
    visibleItems.forEach(function(d) {
      var key, title;
      if (currentGroup === "category") {
        key = d.category; title = key;
      } else if (currentGroup === "policyId") {
        key = d.policyId; title = key + " \u2014 " + d.title;
      } else if (currentGroup === "severity") {
        key = d.severity; title = key;
      }
      if (!groups[key]) {
        groups[key] = { title: title, items: [] };
        groupOrder.push(key);
      }
      groups[key].items.push(d);
    });

    // Sort keys.
    if (currentGroup === "severity") {
      var sevOrder = { CRITICAL: 0, HIGH: 1, MEDIUM: 2, LOW: 3, INFO: 4 };
      groupOrder.sort(function(a, b) {
        return (sevOrder[a] !== undefined ? sevOrder[a] : 99) - (sevOrder[b] !== undefined ? sevOrder[b] : 99);
      });
    } else {
      groupOrder.sort();
    }

    // Build DOM.
    var fragment = document.createDocumentFragment();

    if (groupOrder.length === 0) {
      var msg = document.createElement("div");
      msg.className = "no-results";
      msg.textContent = "No findings match the current filters.";
      fragment.appendChild(msg);
    }

    groupOrder.forEach(function(key) {
      var group = groups[key];
      var isExpanded = !!expandedGroups[key];

      var section = document.createElement("div");
      section.className = "group-section";
      section.setAttribute("data-group-key", key);

      var header = document.createElement("h2");
      header.className = "group-header";

      var left = document.createElement("div");
      left.className = "group-header-left";
      left.innerHTML = '<span class="chevron' + (isExpanded ? " open" : "") + '">&#9654;</span>' +
        '<span>' + escapeHTML(group.title) + '</span>' +
        '<span class="group-count">(' + group.items.length + ')</span>';
      header.appendChild(left);

      if (currentGroup !== "severity") {
        var summary = document.createElement("div");
        summary.className = "group-severity-summary";
        summary.innerHTML = buildSeveritySummaryHTML(group.items);
        header.appendChild(summary);
      }

      section.appendChild(header);

      var body = document.createElement("div");
      body.className = "group-findings";

      if (isExpanded) {
        // Re-render findings for expanded groups.
        var frag = document.createDocumentFragment();
        group.items.forEach(function(d) { frag.appendChild(renderFinding(d)); });
        body.appendChild(frag);
      } else {
        body.style.display = "none";
      }

      section.appendChild(body);

      // Capture group.items for the click handler closure.
      (function(sec, gi) {
        header.addEventListener("click", function() { toggleGroup(sec, gi); });
      })(section, group.items);

      fragment.appendChild(section);
    });

    container.innerHTML = "";
    container.appendChild(fragment);
  }

  // --- Apply all filters and re-render groups ---
  function applyFilters() {
    // Update button states.
    for (var i = 0; i < filterBtns.length; i++) {
      var btn = filterBtns[i];
      var f = btn.getAttribute("data-filter");
      btn.classList.toggle("active", !!activeFilters[f]);
    }

    var needsSeverity = !activeFilters.ALL;
    var needsSearch = searchTerm.length > 0;

    var visible = items.filter(function(d) {
      if (needsSeverity && !activeFilters[d.severity]) return false;
      if (needsSearch && d.searchText.indexOf(searchTerm) === -1) return false;
      return true;
    });

    renderGroups(visible);
  }

  // --- Severity filter buttons ---
  for (var i = 0; i < filterBtns.length; i++) {
    (function(btn) {
      btn.addEventListener("click", function() {
        var filter = btn.getAttribute("data-filter");
        if (filter === "ALL") {
          activeFilters = { ALL: true };
        } else {
          delete activeFilters.ALL;
          if (activeFilters[filter]) delete activeFilters[filter];
          else activeFilters[filter] = true;
          // If nothing selected, revert to ALL.
          var hasAny = false;
          for (var k in activeFilters) { if (activeFilters.hasOwnProperty(k)) { hasAny = true; break; } }
          if (!hasAny) activeFilters.ALL = true;
        }
        applyFilters();
      });
    })(filterBtns[i]);
  }

  // --- Group-by dropdown ---
  if (groupBySelect) {
    groupBySelect.addEventListener("change", function(e) {
      currentGroup = e.target.value;
      expandedGroups = {};
      applyFilters();
    });
  }

  // --- Search input (debounced 200ms) ---
  if (searchInput) {
    searchInput.addEventListener("input", function() {
      clearTimeout(debounceTimer);
      debounceTimer = setTimeout(function() {
        searchTerm = searchInput.value.trim().toLowerCase();
        applyFilters();
      }, 200);
    });
  }

  // --- Expand / Collapse all ---
  if (expandAllBtn) {
    expandAllBtn.addEventListener("click", function() {
      var sections = container.querySelectorAll(".group-section");
      for (var i = 0; i < sections.length; i++) {
        var sec = sections[i];
        var body = sec.querySelector(".group-findings");
        var chevron = sec.querySelector(".chevron");
        var key = sec.getAttribute("data-group-key");
        if (body && !body.hasChildNodes()) {
          // Need to find the group items for this section to render them.
          // We trigger a click on the header which will call toggleGroup.
          var hdr = sec.querySelector(".group-header");
          if (hdr) hdr.click();
        } else if (body) {
          body.style.display = "";
          if (chevron) chevron.classList.add("open");
          if (key) expandedGroups[key] = true;
        }
      }
    });
  }

  if (collapseAllBtn) {
    collapseAllBtn.addEventListener("click", function() {
      expandedGroups = {};
      var sections = container.querySelectorAll(".group-section");
      for (var i = 0; i < sections.length; i++) {
        var body = sections[i].querySelector(".group-findings");
        var chevron = sections[i].querySelector(".chevron");
        if (body) body.style.display = "none";
        if (chevron) chevron.classList.remove("open");
      }
    });
  }

  function escapeHTML(str) {
    var div = document.createElement("div");
    div.textContent = str;
    return div.innerHTML;
  }

  // --- Initial render: show group headers immediately ---
  renderGroups(items);
})();
</script>
</body>
</html>
